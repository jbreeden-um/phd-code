% This file computes \dddot{V}_{max} for use in the psi_v file.
% The result is the same as the result in the prior paper for a circular orbit with the
% same periapsis altitude.

syms mu real
syms x11(t) x12(t) x13(t) x14(t) x01(t) x02(t) x03(t) x04(t)
syms p11 p12 p13 p14 p22 p23 p24 p33 p34 p44 real;
x1 = [x11; x12; x13; x14];
x0 = [x01; x02; x03; x04];
x1d = [x13; x14; -mu*[x11; x12]/(x11^2 + x12^2)^(3/2)];
x0d = [x03; x04; -mu*[x01; x02]/(x01^2 + x02^2)^(3/2)];

P = [p11 p12 p13 p14; p12 p22 p23 p24; p13 p23 p33 p34; p14 p24 p34 p44];
V = (x1 - x0).'*P*(x1 - x0);
Vd = subs(diff(V), [diff(x11); diff(x12); diff(x13); diff(x14); diff(x01); diff(x02); diff(x03); diff(x04)], [x1d; x0d])
Vdd = subs(diff(Vd), [diff(x11); diff(x12); diff(x13); diff(x14); diff(x01); diff(x02); diff(x03); diff(x04)], [x1d; x0d])
Vddd = subs(diff(Vdd), [diff(x11); diff(x12); diff(x13); diff(x14); diff(x01); diff(x02); diff(x03); diff(x04)], [x1d; x0d])


%%
exp = string(Vddd);
exp = replace(exp, {'x11(t)', 'x12(t)', 'x13(t)', 'x14(t)'}, {'x1(1)', 'x1(2)', 'x1(3)', 'x1(4)'});
exp = replace(exp, {'x01(t)', 'x02(t)', 'x03(t)', 'x04(t)'}, {'xc(1)', 'xc(2)', 'xc(3)', 'xc(4)'});
exp = replace(exp, {'p11', 'p12', 'p13', 'p14'}, {'P(1,1)', 'P(1,2)', 'P(1,3)', 'P(1,4)'});
exp = replace(exp, {'p22', 'p23', 'p24'}, {'P(2,2)', 'P(2,3)', 'P(2,4)'});
exp = replace(exp, {'p33', 'p34', 'p44'}, {'P(3,3)', 'P(3,4)', 'P(4,4)'});
fprintf('\n%s\n\n',exp);

%%
mu = 398600e9;
[~, ~, oe] = get_center(0);
n = sqrt(mu/oe.a^3);
A_sys = [0,     0, 1,    0;
         0,     0, 0,    1;
         3*n^2, 0, 0,    2*n;
         0,     0, -2*n, 0];
B_sys = [zeros(2); eye(2)];
R = eye(2)*100;
Q = eye(4);
[~, P, ~] = lqr(A_sys,B_sys,Q,R);
Vddd_f = @(x1, xc) (P(1,3)*(xc(1) - x1(1)) + P(2,3)*(xc(2) - x1(2)) + P(3,3)*(xc(3) - x1(3)) + P(3,4)*(xc(4) - x1(4)))*((mu^2*xc(1))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(1))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(1)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(1)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(3)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(3)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2)) + (P(1,4)*(xc(1) - x1(1)) + P(2,4)*(xc(2) - x1(2)) + P(3,4)*(xc(3) - x1(3)) + P(4,4)*(xc(4) - x1(4)))*((mu^2*xc(2))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(2))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(2)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(2)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(4)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(4)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2)) + 3*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)))*(P(3,3)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(3,4)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2)) - P(1,3)*(xc(3) - x1(3)) - P(2,3)*(xc(4) - x1(4))) + 3*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)))*(P(3,4)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(4,4)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2)) - P(1,4)*(xc(3) - x1(3)) - P(2,4)*(xc(4) - x1(4))) - (xc(1) - x1(1))*(P(1,1)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(1,2)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) - P(1,3)*((mu^2*xc(1))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(1))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(1)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(1)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(3)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(3)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2)) - P(1,4)*((mu^2*xc(2))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(2))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(2)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(2)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(4)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(4)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2))) - (xc(2) - x1(2))*(P(1,2)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(2,2)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) - P(2,3)*((mu^2*xc(1))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(1))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(1)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(1)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(3)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(3)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2)) - P(2,4)*((mu^2*xc(2))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(2))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(2)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(2)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(4)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(4)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2))) - (xc(3) - x1(3))*(P(1,3)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(2,3)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) - P(3,3)*((mu^2*xc(1))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(1))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(1)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(1)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(3)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(3)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2)) - P(3,4)*((mu^2*xc(2))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(2))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(2)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(2)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(4)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(4)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2))) - (xc(4) - x1(4))*(P(1,4)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(2,4)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) - P(3,4)*((mu^2*xc(1))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(1))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(1)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(1)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(3)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(3)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2)) - P(4,4)*((mu^2*xc(2))/(xc(1)^2 + xc(2)^2)^3 - (mu^2*x1(2))/(x1(1)^2 + x1(2)^2)^3 - (15*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4))^2)/(4*(xc(1)^2 + xc(2)^2)^(7/2)) + (15*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4))^2)/(4*(x1(1)^2 + x1(2)^2)^(7/2)) + (3*mu*xc(2)*(2*xc(3)^2 + 2*xc(4)^2 - (2*mu*xc(1)^2)/(xc(1)^2 + xc(2)^2)^(3/2) - (2*mu*xc(2)^2)/(xc(1)^2 + xc(2)^2)^(3/2)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) - (3*mu*x1(2)*(2*x1(3)^2 + 2*x1(4)^2 - (2*mu*x1(1)^2)/(x1(1)^2 + x1(2)^2)^(3/2) - (2*mu*x1(2)^2)/(x1(1)^2 + x1(2)^2)^(3/2)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)) + (3*mu*xc(4)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(xc(1)^2 + xc(2)^2)^(5/2) - (3*mu*x1(4)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(x1(1)^2 + x1(2)^2)^(5/2))) - ((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)))*(P(1,1)*(xc(1) - x1(1)) + P(1,2)*(xc(2) - x1(2)) + P(1,3)*(xc(3) - x1(3)) + P(1,4)*(xc(4) - x1(4))) - ((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2)))*(P(1,2)*(xc(1) - x1(1)) + P(2,2)*(xc(2) - x1(2)) + P(2,3)*(xc(3) - x1(3)) + P(2,4)*(xc(4) - x1(4))) + 3*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2))*(P(1,3)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(1,4)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2)) - P(1,1)*(xc(3) - x1(3)) - P(1,2)*(xc(4) - x1(4))) + 3*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2))*(P(2,3)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(2,4)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2)) - P(1,2)*(xc(3) - x1(3)) - P(2,2)*(xc(4) - x1(4))) + 3*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2))*(P(3,3)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(3,4)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(1,3)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(2,3)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2))) + 3*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2))*(P(3,4)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(4,4)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(1,4)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(2,4)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2))) - 3*(xc(3) - x1(3))*(P(1,3)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(1,4)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(1,1)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(1,2)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2))) - 3*(xc(4) - x1(4))*(P(2,3)*((mu*xc(3))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(3))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(1)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(1)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(2,4)*((mu*xc(4))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(4))/(x1(1)^2 + x1(2)^2)^(3/2) - (3*mu*xc(2)*(2*xc(1)*xc(3) + 2*xc(2)*xc(4)))/(2*(xc(1)^2 + xc(2)^2)^(5/2)) + (3*mu*x1(2)*(2*x1(1)*x1(3) + 2*x1(2)*x1(4)))/(2*(x1(1)^2 + x1(2)^2)^(5/2))) + P(1,2)*((mu*xc(1))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(1))/(x1(1)^2 + x1(2)^2)^(3/2)) + P(2,2)*((mu*xc(2))/(xc(1)^2 + xc(2)^2)^(3/2) - (mu*x1(2))/(x1(1)^2 + x1(2)^2)^(3/2)));

period = 2*pi*sqrt(oe.a^3/mu);
level = 5e4;
rel_pos = sqrt(level/min(eig(P)));
rel_vel = sqrt(level/max(eig(P)));
b = [rel_pos; rel_pos; rel_vel; rel_vel]*1.1;

obj = @(x) -Vddd_f(x(1:4), get_center(x(5)));
N = 100;
x_crit = [0;0;0;0;0];
f_crit = Inf;
f_crit_all = [0,0,0];
x_crit_all = zeros(5,3);
tic
for j=0:2
    t_guess = period*j/2;
    if j==1, t_guess = rand*period; end
    for i=1:N
        x_guess = [get_center(t_guess) + randn(4,1).*b/1.5; t_guess];
        [x_val, f_val] = fmincon(obj, x_guess, [], [], [], [], [-1e7;-1e7;-1e7;-1e7; -0.05*period], [1e7;1e7;1e7;1e7; 1.05*period], ...
            @(x) nonlin(x(1:4), P, level, get_center(x(5))), optimset('Display', 'off'));
        if f_val < f_crit && nonlin(x_val(1:4), P, level, get_center(x_val(5))) <= 0
            f_crit = f_val;
            x_crit = x_val;
        end
        waitbar((j*N+i)/(3*N));
    end
    f_crit_all(j+1) = f_crit;
    if length(x_crit)==5
        x_crit_all(:,j+1) = x_crit;
    else
        x_crit_all(:,j+1) = [x_crit; t_guess];
    end
    f_crit = Inf;
end
toc
Kdd_max = -min(f_crit_all)
if length(x_crit)==5
    check_negative = nonlin(x_crit(1:4), P, level, get_center(x_crit(5)))
else
    check_negative = nonlin(x_crit(1:4), P, level, get_center(t_guess))
end

%%
levels = [5e4 5e5 5e6 5e7];
Vddd_max_arr = [0.205056249789470 2.050638971912750 20.508771244661691  2.051629414954614e+02];
plot(levels, Vddd_max_arr);
m = 4.11e-06;
% Vddd_max vs V follows an almost exactly linear curve with the above coefficient

function [C, Ceq] = nonlin(x, P, level, x0)
x1 = x(1:4);
C = (x1 - x0)'*P*(x1 - x0) - level;
Ceq = [];
end